import{c as Fe,r as t,j as e,a as Ve,b as De,u as Ke,d as We,R as Xe,e as Ie,A as Je,P as Ze,f as Q,g as Oe,h as et,i as tt,D as st,C as rt,k as nt,l as at,m as ot,n as be,o as Ce,p as we,q as he,s as Ne,t as Te,v as W,w as X,B as P,T as pe,L as I,I as ae,S as it,x as ct,y as lt,z as dt,E as ut,F as oe,G as mt,X as ie,H as Le,J as qe,K as J,M as ht,N as pt,O as Pe,Q as Se,U as ke,_ as xt,V as ft,W as gt,Y as vt,Z as jt,$ as yt,a0 as bt}from"./index-BRaaWty1.js";import{U as me}from"./upload-CEIhjUlp.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ct=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]],wt=Fe("external-link",Ct);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nt=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],Re=Fe("plus",Nt);var[ce]=Ve("Tooltip",[De]),le=De(),Be="TooltipProvider",Tt=700,xe="tooltip.open",[Pt,ve]=ce(Be),Me=s=>{const{__scopeTooltip:n,delayDuration:r=Tt,skipDelayDuration:a=300,disableHoverableContent:o=!1,children:u}=s,d=t.useRef(!0),v=t.useRef(!1),c=t.useRef(0);return t.useEffect(()=>{const g=c.current;return()=>window.clearTimeout(g)},[]),e.jsx(Pt,{scope:n,isOpenDelayedRef:d,delayDuration:r,onOpen:t.useCallback(()=>{window.clearTimeout(c.current),d.current=!1},[]),onClose:t.useCallback(()=>{window.clearTimeout(c.current),c.current=window.setTimeout(()=>d.current=!0,a)},[a]),isPointerInTransitRef:v,onPointerInTransitChange:t.useCallback(g=>{v.current=g},[]),disableHoverableContent:o,children:u})};Me.displayName=Be;var Z="Tooltip",[St,ee]=ce(Z),He=s=>{const{__scopeTooltip:n,children:r,open:a,defaultOpen:o,onOpenChange:u,disableHoverableContent:d,delayDuration:v}=s,c=ve(Z,s.__scopeTooltip),g=le(n),[l,f]=t.useState(null),h=Ke(),m=t.useRef(0),y=d??c.disableHoverableContent,C=v??c.delayDuration,j=t.useRef(!1),[b,w]=We({prop:a,defaultProp:o??!1,onChange:O=>{O?(c.onOpen(),document.dispatchEvent(new CustomEvent(xe))):c.onClose(),u?.(O)},caller:Z}),R=t.useMemo(()=>b?j.current?"delayed-open":"instant-open":"closed",[b]),F=t.useCallback(()=>{window.clearTimeout(m.current),m.current=0,j.current=!1,w(!0)},[w]),S=t.useCallback(()=>{window.clearTimeout(m.current),m.current=0,w(!1)},[w]),A=t.useCallback(()=>{window.clearTimeout(m.current),m.current=window.setTimeout(()=>{j.current=!0,w(!0),m.current=0},C)},[C,w]);return t.useEffect(()=>()=>{m.current&&(window.clearTimeout(m.current),m.current=0)},[]),e.jsx(Xe,{...g,children:e.jsx(St,{scope:n,contentId:h,open:b,stateAttribute:R,trigger:l,onTriggerChange:f,onTriggerEnter:t.useCallback(()=>{c.isOpenDelayedRef.current?A():F()},[c.isOpenDelayedRef,A,F]),onTriggerLeave:t.useCallback(()=>{y?S():(window.clearTimeout(m.current),m.current=0)},[S,y]),onOpen:F,onClose:S,disableHoverableContent:y,children:r})})};He.displayName=Z;var fe="TooltipTrigger",ze=t.forwardRef((s,n)=>{const{__scopeTooltip:r,...a}=s,o=ee(fe,r),u=ve(fe,r),d=le(r),v=t.useRef(null),c=Ie(n,v,o.onTriggerChange),g=t.useRef(!1),l=t.useRef(!1),f=t.useCallback(()=>g.current=!1,[]);return t.useEffect(()=>()=>document.removeEventListener("pointerup",f),[f]),e.jsx(Je,{asChild:!0,...d,children:e.jsx(Ze.button,{"aria-describedby":o.open?o.contentId:void 0,"data-state":o.stateAttribute,...a,ref:c,onPointerMove:Q(s.onPointerMove,h=>{h.pointerType!=="touch"&&!l.current&&!u.isPointerInTransitRef.current&&(o.onTriggerEnter(),l.current=!0)}),onPointerLeave:Q(s.onPointerLeave,()=>{o.onTriggerLeave(),l.current=!1}),onPointerDown:Q(s.onPointerDown,()=>{o.open&&o.onClose(),g.current=!0,document.addEventListener("pointerup",f,{once:!0})}),onFocus:Q(s.onFocus,()=>{g.current||o.onOpen()}),onBlur:Q(s.onBlur,o.onClose),onClick:Q(s.onClick,o.onClose)})})});ze.displayName=fe;var je="TooltipPortal",[kt,Rt]=ce(je,{forceMount:void 0}),Ue=s=>{const{__scopeTooltip:n,forceMount:r,children:a,container:o}=s,u=ee(je,n);return e.jsx(kt,{scope:n,forceMount:r,children:e.jsx(Oe,{present:r||u.open,children:e.jsx(et,{asChild:!0,container:o,children:a})})})};Ue.displayName=je;var Y="TooltipContent",$e=t.forwardRef((s,n)=>{const r=Rt(Y,s.__scopeTooltip),{forceMount:a=r.forceMount,side:o="top",...u}=s,d=ee(Y,s.__scopeTooltip);return e.jsx(Oe,{present:a||d.open,children:d.disableHoverableContent?e.jsx(Qe,{side:o,...u,ref:n}):e.jsx(Et,{side:o,...u,ref:n})})}),Et=t.forwardRef((s,n)=>{const r=ee(Y,s.__scopeTooltip),a=ve(Y,s.__scopeTooltip),o=t.useRef(null),u=Ie(n,o),[d,v]=t.useState(null),{trigger:c,onClose:g}=r,l=o.current,{onPointerInTransitChange:f}=a,h=t.useCallback(()=>{v(null),f(!1)},[f]),m=t.useCallback((y,C)=>{const j=y.currentTarget,b={x:y.clientX,y:y.clientY},w=Dt(b,j.getBoundingClientRect()),R=It(b,w),F=Ot(C.getBoundingClientRect()),S=qt([...R,...F]);v(S),f(!0)},[f]);return t.useEffect(()=>()=>h(),[h]),t.useEffect(()=>{if(c&&l){const y=j=>m(j,l),C=j=>m(j,c);return c.addEventListener("pointerleave",y),l.addEventListener("pointerleave",C),()=>{c.removeEventListener("pointerleave",y),l.removeEventListener("pointerleave",C)}}},[c,l,m,h]),t.useEffect(()=>{if(d){const y=C=>{const j=C.target,b={x:C.clientX,y:C.clientY},w=c?.contains(j)||l?.contains(j),R=!Lt(b,d);w?h():R&&(h(),g())};return document.addEventListener("pointermove",y),()=>document.removeEventListener("pointermove",y)}},[c,l,d,g,h]),e.jsx(Qe,{...s,ref:u})}),[_t,At]=ce(Z,{isInside:!1}),Ft=nt("TooltipContent"),Qe=t.forwardRef((s,n)=>{const{__scopeTooltip:r,children:a,"aria-label":o,onEscapeKeyDown:u,onPointerDownOutside:d,...v}=s,c=ee(Y,r),g=le(r),{onClose:l}=c;return t.useEffect(()=>(document.addEventListener(xe,l),()=>document.removeEventListener(xe,l)),[l]),t.useEffect(()=>{if(c.trigger){const f=h=>{h.target?.contains(c.trigger)&&l()};return window.addEventListener("scroll",f,{capture:!0}),()=>window.removeEventListener("scroll",f,{capture:!0})}},[c.trigger,l]),e.jsx(st,{asChild:!0,disableOutsidePointerEvents:!1,onEscapeKeyDown:u,onPointerDownOutside:d,onFocusOutside:f=>f.preventDefault(),onDismiss:l,children:e.jsxs(rt,{"data-state":c.stateAttribute,...g,...v,ref:n,style:{...v.style,"--radix-tooltip-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-tooltip-content-available-width":"var(--radix-popper-available-width)","--radix-tooltip-content-available-height":"var(--radix-popper-available-height)","--radix-tooltip-trigger-width":"var(--radix-popper-anchor-width)","--radix-tooltip-trigger-height":"var(--radix-popper-anchor-height)"},children:[e.jsx(Ft,{children:a}),e.jsx(_t,{scope:r,isInside:!0,children:e.jsx(at,{id:c.contentId,role:"tooltip",children:o||a})})]})})});$e.displayName=Y;var Ye="TooltipArrow",Ge=t.forwardRef((s,n)=>{const{__scopeTooltip:r,...a}=s,o=le(r);return At(Ye,r).isInside?null:e.jsx(tt,{...o,...a,ref:n})});Ge.displayName=Ye;function Dt(s,n){const r=Math.abs(n.top-s.y),a=Math.abs(n.bottom-s.y),o=Math.abs(n.right-s.x),u=Math.abs(n.left-s.x);switch(Math.min(r,a,o,u)){case u:return"left";case o:return"right";case r:return"top";case a:return"bottom";default:throw new Error("unreachable")}}function It(s,n,r=5){const a=[];switch(n){case"top":a.push({x:s.x-r,y:s.y+r},{x:s.x+r,y:s.y+r});break;case"bottom":a.push({x:s.x-r,y:s.y-r},{x:s.x+r,y:s.y-r});break;case"left":a.push({x:s.x+r,y:s.y-r},{x:s.x+r,y:s.y+r});break;case"right":a.push({x:s.x-r,y:s.y-r},{x:s.x-r,y:s.y+r});break}return a}function Ot(s){const{top:n,right:r,bottom:a,left:o}=s;return[{x:o,y:n},{x:r,y:n},{x:r,y:a},{x:o,y:a}]}function Lt(s,n){const{x:r,y:a}=s;let o=!1;for(let u=0,d=n.length-1;u<n.length;d=u++){const v=n[u],c=n[d],g=v.x,l=v.y,f=c.x,h=c.y;l>a!=h>a&&r<(f-g)*(a-l)/(h-l)+g&&(o=!o)}return o}function qt(s){const n=s.slice();return n.sort((r,a)=>r.x<a.x?-1:r.x>a.x?1:r.y<a.y?-1:r.y>a.y?1:0),Bt(n)}function Bt(s){if(s.length<=1)return s.slice();const n=[];for(let a=0;a<s.length;a++){const o=s[a];for(;n.length>=2;){const u=n[n.length-1],d=n[n.length-2];if((u.x-d.x)*(o.y-d.y)>=(u.y-d.y)*(o.x-d.x))n.pop();else break}n.push(o)}n.pop();const r=[];for(let a=s.length-1;a>=0;a--){const o=s[a];for(;r.length>=2;){const u=r[r.length-1],d=r[r.length-2];if((u.x-d.x)*(o.y-d.y)>=(u.y-d.y)*(o.x-d.x))r.pop();else break}r.push(o)}return r.pop(),n.length===1&&r.length===1&&n[0].x===r[0].x&&n[0].y===r[0].y?n:n.concat(r)}var Mt=Me,Ht=He,zt=ze,Ut=Ue,$t=$e,Qt=Ge;function ge({delayDuration:s=0,...n}){return e.jsx(Mt,{"data-slot":"tooltip-provider",delayDuration:s,...n})}function Ee({...s}){return e.jsx(ge,{children:e.jsx(Ht,{"data-slot":"tooltip",...s})})}function _e({...s}){return e.jsx(zt,{"data-slot":"tooltip-trigger",...s})}function Ae({className:s,sideOffset:n=0,children:r,...a}){return e.jsx(Ut,{children:e.jsxs($t,{"data-slot":"tooltip-content",sideOffset:n,className:ot("bg-primary text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-fit origin-(--radix-tooltip-content-transform-origin) rounded-md px-3 py-1.5 text-xs text-balance",s),...a,children:[r,e.jsx(Qt,{className:"bg-primary fill-primary z-50 size-2.5 translate-y-[calc(-50%_-_2px)] rotate-45 rounded-[2px]"})]})})}function Yt({barcode:s,onSuccess:n,onCancel:r}){const[a,o]=t.useState(""),[u,d]=t.useState(""),[v,c]=t.useState(""),[g,l]=t.useState([]),[f,h]=t.useState(""),[m,y]=t.useState(""),[C,j]=t.useState("en"),[b,w]=t.useState({}),[R,F]=t.useState(!1),[S,A]=t.useState(!1),[O,L]=t.useState(null),[M,H]=t.useState(!1),[q,G]=t.useState(null),D=t.useRef(null),z=t.useRef(null),$=t.useRef(null),te=["Food","Beverages","Snacks","Dairy products","Meat","Fish","Fruits","Vegetables","Cereals and potatoes","Bread","Sweets","Condiments","Prepared meals","Baby food","Frozen foods","Canned foods"],se=[{code:"en",name:"English"},{code:"fr",name:"French"},{code:"es",name:"Spanish"},{code:"de",name:"German"},{code:"it",name:"Italian"},{code:"pt",name:"Portuguese"},{code:"nl",name:"Dutch"},{code:"pl",name:"Polish"},{code:"ru",name:"Russian"},{code:"ja",name:"Japanese"},{code:"zh",name:"Chinese"}],B=p=>i=>{const x=i.target.files?.[0];if(x){if(!x.type.startsWith("image/")){ke.error("Please select a valid image file.");return}if(x.size>10*1024*1024){ke.error("Image file is too large. Please select an image smaller than 10MB.");return}w(T=>({...T,[p]:x})),i.target.value=""}},V=p=>{w(i=>{const x={...i};return delete x[p],x})},re=()=>{f.trim()&&!g.includes(f.trim())&&(l(p=>[...p,f.trim()]),h(""))},de=p=>{l(i=>i.filter(x=>x!==p))},K=async p=>{if(p.preventDefault(),!R){L("Please agree to the Creative Commons license to submit photos.");return}if(!a.trim()){L("Product name is required.");return}A(!0),L(null);try{const i=new FormData;i.append("barcode",s),i.append("product_name",a.trim()),i.append("brands",u.trim()),i.append("quantity",v.trim()),i.append("categories",g.join(", ")),i.append("ingredients_text",m.trim()),i.append("lc",C),console.log("Submitting product data to backend...");const x=await fetch(`https://${Pe}.supabase.co/functions/v1/make-server-5111eaf7/product/submit`,{method:"POST",headers:{Authorization:`Bearer ${Se}`},body:i});if(!x.ok){const _=await x.json();throw new Error(_.error||"Failed to submit product")}const T=await x.json();console.log("Product submitted successfully:",T);const E=[];for(const[_,N]of Object.entries(b))if(N){const k=new FormData;k.append(`imgupload_${_}`,N),k.append("lc",C),console.log(`Uploading ${_} image...`);const U=fetch(`https://${Pe}.supabase.co/functions/v1/make-server-5111eaf7/product/${s}/image/${_}`,{method:"POST",headers:{Authorization:`Bearer ${Se}`},body:k});E.push(U)}if(E.length>0){console.log(`Uploading ${E.length} images...`);const N=(await Promise.allSettled(E)).filter(k=>k.status==="rejected");N.length>0&&console.warn("Some image uploads failed:",N)}H(!0),G(T.product_url),setTimeout(()=>{n(T.product_url)},2e3)}catch(i){console.error("Error submitting product:",i),L(i.message||"Failed to submit product. Please try again.")}finally{A(!1)}};return M?e.jsxs(be,{children:[e.jsxs(Ce,{children:[e.jsxs(we,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-6 w-6 text-green-600"}),"Product Added Successfully!"]}),e.jsx(Ne,{children:"Thank you for contributing to the OpenFoodFacts database!"})]}),e.jsxs(Te,{className:"space-y-4",children:[e.jsxs(W,{children:[e.jsx(he,{className:"h-4 w-4"}),e.jsxs(X,{children:['Your product "',a,'" has been submitted to OpenFoodFacts and will be available shortly.']})]}),q&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(P,{variant:"outline",size:"sm",onClick:()=>window.open(q,"_blank"),className:"flex items-center gap-2",children:[e.jsx(wt,{className:"h-4 w-4"}),"View on OpenFoodFacts"]})})]})]}):e.jsxs(be,{children:[e.jsxs(Ce,{children:[e.jsxs(we,{className:"flex items-center gap-2",children:[e.jsx(Re,{className:"h-6 w-6 text-blue-600"}),"Help Add This Product"]}),e.jsxs(Ne,{children:["This product (barcode: ",s,") isn't in the OpenFoodFacts database yet. Help the community by adding it!"]})]}),e.jsx(Te,{children:e.jsxs("form",{onSubmit:K,className:"space-y-6",children:[O&&e.jsxs(W,{variant:"destructive",children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx(X,{children:O})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(I,{htmlFor:"productName",children:"Product Name *"}),e.jsx(ae,{id:"productName",value:a,onChange:p=>o(p.target.value),placeholder:"e.g., Organic Tomato Sauce",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(I,{htmlFor:"brands",children:"Brand(s)"}),e.jsx(ae,{id:"brands",value:u,onChange:p=>d(p.target.value),placeholder:"e.g., Heinz, Kraft"})]}),e.jsxs("div",{children:[e.jsx(I,{htmlFor:"quantity",children:"Quantity"}),e.jsx(ae,{id:"quantity",value:v,onChange:p=>c(p.target.value),placeholder:"e.g., 500g, 12 fl oz"})]})]}),e.jsxs("div",{children:[e.jsx(I,{htmlFor:"language",children:"Primary Language"}),e.jsxs(it,{value:C,onValueChange:j,children:[e.jsx(ct,{children:e.jsx(lt,{})}),e.jsx(dt,{children:se.map(p=>e.jsx(ut,{value:p.code,children:p.name},p.code))})]})]})]}),e.jsx(oe,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(I,{children:"Categories"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:g.map(p=>e.jsxs(mt,{variant:"secondary",className:"flex items-center gap-1",children:[p,e.jsx(P,{type:"button",variant:"ghost",size:"sm",className:"h-auto p-0 ml-1",onClick:()=>de(p),children:e.jsx(ie,{className:"h-3 w-3"})})]},p))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ae,{placeholder:"Add category",value:f,onChange:p=>h(p.target.value),onKeyPress:p=>p.key==="Enter"&&(p.preventDefault(),re())}),e.jsx(P,{type:"button",onClick:re,size:"sm",children:"Add"})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Common categories: ",te.slice(0,5).join(", "),", ..."]})]}),e.jsx(oe,{}),e.jsxs("div",{children:[e.jsx(I,{htmlFor:"ingredients",children:"Ingredients"}),e.jsx(Le,{id:"ingredients",value:m,onChange:p=>y(p.target.value),placeholder:"List all ingredients as they appear on the package, separated by commas",rows:4})]}),e.jsx(oe,{}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{children:"Product Photos"}),e.jsx(ge,{children:e.jsxs(Ee,{children:[e.jsx(_e,{children:e.jsx(qe,{className:"h-4 w-4 text-muted-foreground"})}),e.jsx(Ae,{className:"max-w-sm",asChild:!0,children:e.jsx("div",{children:"Photos help verify product information. Take clear photos of: • Front of package (with product name and brand) • Ingredients list • Nutrition facts (if available)"})})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{className:"text-sm",children:"Front Package"}),b.front?e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"bg-muted p-4 rounded-lg text-center",children:[e.jsx(J,{className:"h-8 w-8 mx-auto mb-2 text-muted-foreground"}),e.jsx("p",{className:"text-sm",children:"Front image selected"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:b.front.name})]}),e.jsx(P,{type:"button",variant:"destructive",size:"sm",className:"absolute -top-2 -right-2",onClick:()=>V("front"),children:e.jsx(ie,{className:"h-3 w-3"})})]}):e.jsxs(P,{type:"button",variant:"outline",className:"w-full h-24 flex flex-col items-center gap-2",onClick:()=>D.current?.click(),children:[e.jsx(me,{className:"h-4 w-4"}),"Upload Front"]}),e.jsx("input",{ref:D,type:"file",accept:"image/*",onChange:B("front"),className:"hidden"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{className:"text-sm",children:"Ingredients List"}),b.ingredients?e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"bg-muted p-4 rounded-lg text-center",children:[e.jsx(J,{className:"h-8 w-8 mx-auto mb-2 text-muted-foreground"}),e.jsx("p",{className:"text-sm",children:"Ingredients image selected"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:b.ingredients.name})]}),e.jsx(P,{type:"button",variant:"destructive",size:"sm",className:"absolute -top-2 -right-2",onClick:()=>V("ingredients"),children:e.jsx(ie,{className:"h-3 w-3"})})]}):e.jsxs(P,{type:"button",variant:"outline",className:"w-full h-24 flex flex-col items-center gap-2",onClick:()=>z.current?.click(),children:[e.jsx(me,{className:"h-4 w-4"}),"Upload Ingredients"]}),e.jsx("input",{ref:z,type:"file",accept:"image/*",onChange:B("ingredients"),className:"hidden"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{className:"text-sm",children:"Nutrition Facts"}),b.nutrition?e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"bg-muted p-4 rounded-lg text-center",children:[e.jsx(J,{className:"h-8 w-8 mx-auto mb-2 text-muted-foreground"}),e.jsx("p",{className:"text-sm",children:"Nutrition image selected"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:b.nutrition.name})]}),e.jsx(P,{type:"button",variant:"destructive",size:"sm",className:"absolute -top-2 -right-2",onClick:()=>V("nutrition"),children:e.jsx(ie,{className:"h-3 w-3"})})]}):e.jsxs(P,{type:"button",variant:"outline",className:"w-full h-24 flex flex-col items-center gap-2",onClick:()=>$.current?.click(),children:[e.jsx(me,{className:"h-4 w-4"}),"Upload Nutrition"]}),e.jsx("input",{ref:$,type:"file",accept:"image/*",onChange:B("nutrition"),className:"hidden"})]})]})]}),e.jsx(oe,{}),e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(ht,{id:"license",checked:R,onCheckedChange:p=>F(p)}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs(I,{htmlFor:"license",className:"text-sm",children:["I took these photos and agree to publish them under"," ",e.jsx("a",{href:"https://creativecommons.org/licenses/by-sa/3.0/",target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline",children:"CC BY-SA 3.0 license"})]}),e.jsx(ge,{children:e.jsxs(Ee,{children:[e.jsx(_e,{asChild:!0,children:e.jsx("span",{className:"text-xs text-muted-foreground cursor-help text-left block",children:"ⓘ What does this mean?"})}),e.jsx(Ae,{className:"max-w-sm",asChild:!0,children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{children:"The Creative Commons BY-SA license means:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-xs",children:[e.jsx("li",{children:"Others can use and modify your photos"}),e.jsx("li",{children:"They must give you credit"}),e.jsx("li",{children:"They must share under the same license"}),e.jsx("li",{children:"This helps keep OpenFoodFacts free and open"})]})]})})]})})]})]})}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(P,{type:"submit",disabled:S||!R,className:"flex items-center gap-2",children:S?e.jsxs(e.Fragment,{children:[e.jsx(pt,{className:"h-4 w-4 animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Re,{className:"h-4 w-4"}),"Add Product"]})}),e.jsx(P,{type:"button",variant:"outline",onClick:r,disabled:S,children:"Cancel"})]})]})})]})}function Gt({showAddProductForm:s,scannedBarcode:n,onProductAdded:r,onCancelAddProduct:a,barcodeError:o,barcodeDebug:u,cameraError:d,cameraPermission:v,onRequestCameraPermission:c,isScanning:g,isLoadingProduct:l,onStartCamera:f,onStopCamera:h,productFound:m,quaggaContainerRef:y,canUseCamera:C,ingredients:j,onIngredientsChange:b,activeTab:w}){return s&&n?e.jsx(Yt,{barcode:n,onSuccess:r,onCancel:a}):e.jsxs("div",{className:"text-center space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground mb-2",children:"Scan a product barcode to automatically fetch ingredient information"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Uses the OpenFoodFacts database - help improve it by adding missing products!"})]}),o&&e.jsxs(W,{variant:s?"default":"destructive",children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx(X,{children:o})]}),u&&e.jsx("div",{className:"text-xs text-muted-foreground bg-muted/40 rounded px-3 py-2",children:u}),d&&e.jsxs(W,{variant:"destructive",children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx(X,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"whitespace-pre-line",children:d}),v==="denied"&&e.jsx(P,{variant:"outline",size:"sm",onClick:showCameraPermissionPrompt,className:"w-full",children:"Try Camera Again"})]})})]}),m&&e.jsxs(W,{children:[e.jsx(he,{className:"h-4 w-4"}),e.jsx(X,{children:e.jsxs("div",{className:"text-left",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Product Found:"})," ",m.name]}),m.brand&&e.jsxs("div",{children:[e.jsx("strong",{children:"Brand:"})," ",m.brand]}),m.quantity&&e.jsxs("div",{children:[e.jsx("strong",{children:"Quantity:"})," ",m.quantity]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["Barcode: ",m.barcode]})]})})]}),g?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative max-w-md mx-auto h-64 bg-black/80 rounded-lg border overflow-hidden shadow-inner",children:[e.jsx("div",{ref:y,className:"absolute inset-0"}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",children:e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsx("div",{className:"border-2 border-white border-dashed rounded-lg w-48 h-32 flex items-center justify-center",children:e.jsx("span",{className:"text-white text-sm bg-black bg-opacity-50 px-2 py-1 rounded text-center",children:"Position barcode here"})})})})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(P,{onClick:h,variant:"outline",disabled:l,children:"Cancel"}),e.jsx(P,{onClick:f,disabled:l,children:"Rescan"})]})]}):e.jsxs("div",{className:"space-y-3 text-center",children:[e.jsxs(P,{onClick:c,disabled:l,className:"mx-auto flex items-center gap-2",children:[e.jsx(J,{className:"h-4 w-4"}),"Start Camera"]}),!C&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Camera not supported on this device or browser"})]}),j&&w==="barcode"&&!s&&e.jsxs("div",{className:"mt-4 text-left",children:[e.jsx("label",{className:"block mb-2",children:"Product Ingredients:"}),e.jsx(Le,{value:j,onChange:R=>b(R.target.value),rows:4,className:"w-full",placeholder:"Ingredients will appear here after scanning..."}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"You can edit the ingredients if needed before analysis"})]})]})}function Vt({onIngredientsFound:s,onAnalyzeText:n,onPermissionChange:r}){const[a,o]=t.useState(!1),[u,d]=t.useState(!1),[v,c]=t.useState(null),[g,l]=t.useState(null),[f,h]=t.useState(null),[m,y]=t.useState(null),[C,j]=t.useState(!1),[b,w]=t.useState(null),[R,F]=t.useState(!1),S=t.useRef(null),A=t.useRef(null),O=t.useRef(null),L=t.useRef(null),M=t.useRef(0),H=t.useRef(!1),q=t.useRef(null),G=t.useRef(0),D=t.useCallback(()=>{q.current&&(q.current.abort(),q.current=null)},[]),z=t.useCallback(()=>{try{const i=A.current;i&&i.stop&&(O.current&&(i.offDetected(O.current),O.current=null),L.current&&(i.offProcessed(L.current),L.current=null),i.stop())}catch(i){console.debug("Error stopping Quagga:",i)}M.current=0,H.current=!1},[]),$=t.useCallback(()=>{z(),D(),o(!1),c(null),h(null)},[D,z]),te=t.useCallback(async()=>{if(A.current)return A.current;const i=await xt(()=>import("https://cdn.skypack.dev/@ericblade/quagga2@1.2.6?min"),[]);return A.current=i.default||i,A.current},[]),se=t.useCallback(i=>{const x=[i.ingredients_text_en,i.ingredients_text,i.ingredients_text_fr,i.ingredients_text_es];for(const T of x)if(typeof T=="string"&&T.trim())return T.trim();if(Array.isArray(i.ingredients)){const T=i.ingredients.map(E=>typeof E=="string"?E:E&&typeof E.text=="string"?E.text:null).filter(Boolean);if(T.length)return T.join(", ")}return null},[]),B=t.useCallback(async i=>{try{D();const x=new AbortController;q.current=x;const T=G.current+1;G.current=T,F(!0),l(null),y(i),console.log(`Fetching product info for barcode: ${i}`);const E=["code","product_name","brands","quantity","ingredients_text","ingredients_text_en","ingredients","image_ingredients_url"],_=`https://world.openfoodfacts.org/api/v2/product/${encodeURIComponent(i)}.json?fields=${E.join(",")}`,k=await(await fetch(_,{headers:{Accept:"application/json"},signal:x.signal})).json();if(k.status!==1||!k.product){console.warn("Product lookup failed",k),w(null),j(!0),l("Product not found in Open Food Facts. Help add it!"),h("Open Food Facts did not return a product for this barcode.");return}const U=k.product,ye={name:U.product_name||"Unnamed product",brand:U.brands||void 0,quantity:U.quantity||void 0,barcode:U.code||i};w(ye),h(`Fetched product from Open Food Facts (${ye.name})`);const ue=se(U);if(ue){s(ue);try{await n(ue),h(ne=>ne?`${ne} • Analysis complete.`:"Analysis complete.")}catch(ne){console.error("Failed to analyze ingredients from Open Food Facts",ne),h("Retrieved ingredients but analysis failed. Check console for details.")}}else l("Product found but no ingredients listed. You can help add the missing details."),h("Product had no ingredient text. Prompting manual contribution."),j(!0)}catch(x){if(x?.name==="AbortError")return;console.error("Error fetching product info:",x),l("Failed to fetch product information. Please try again or enter ingredients manually.")}finally{G.current===requestId&&(F(!1),q.current===controller&&(q.current=null))}},[D,se,n,s]),V=t.useCallback(async()=>{c(null),l(null),o(!0),d(!1);try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera not supported on this device or browser.");if(location.protocol!=="https:"&&location.hostname!=="localhost")throw new Error("Camera access requires a secure connection (HTTPS).");const i=await te();h("Initializing barcode scanner..."),M.current=0,H.current=!1,i.init({inputStream:{type:"LiveStream",target:S.current||void 0,constraints:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}},decoder:{readers:["ean_reader","ean_8_reader","code_128_reader","upc_reader","upc_e_reader"]},locate:!0},x=>{if(x){console.error("Quagga initialization error:",x),o(!1),l("Failed to start barcode scanner. "+(x?.message||"")),h("Initialization error. See console.");return}h("Scanning for barcode...");const T=_=>{const N=_?.codeResult?.code?.trim();!N||H.current||(console.log("Barcode detected via Quagga:",N),H.current=!0,h(`Detected barcode: ${N}`),$(),B(N))},E=()=>{H.current||(M.current+=1,M.current%25===0&&h(`Scanning... ${M.current} frames with no match. Adjust distance, lighting, or angle.`))};O.current=T,L.current=E,i.onDetected(T),i.onProcessed(E),i.start(),requestAnimationFrame(()=>{const _=S.current;if(!_)return;const N=_.querySelector("video"),k=_.querySelector("canvas");N&&(N.setAttribute("playsinline","true"),N.style.width="100%",N.style.height="100%",N.style.objectFit="cover",N.style.position="absolute",N.style.inset="0"),k&&(k.style.width="100%",k.style.height="100%",k.style.position="absolute",k.style.inset="0")})}),r?.("granted")}catch(i){console.error("Camera access error:",i),o(!1);let x="";i.name==="NotAllowedError"?(r?.("denied"),x='Camera access was denied. To use the camera feature, click "Allow" when prompted or adjust your browser settings to enable the camera.'):i.name==="NotFoundError"?x="No camera found on this device.":i.name==="NotSupportedError"?x="Camera not supported on this device or browser.":i.name==="NotReadableError"?x="Camera is already in use by another application. Please close other apps using the camera and try again.":x=i.message||"An unknown error occurred.",c(x),h(null)}},[B,te,r,$]),re=t.useCallback(()=>{d(!0)},[]),de=t.useCallback(i=>{j(!1),y(null),l(null),m&&setTimeout(()=>{B(m)},1e3)},[B,m]),K=t.useCallback(()=>{D(),j(!1),y(null),l(null),w(null),h(null)},[D]),p=t.useCallback(()=>{K()},[K]);return t.useEffect(()=>()=>{z(),D()},[D,z]),{isScanning:a,showCameraPrompt:u,cameraError:v,barcodeError:g,barcodeDebug:f,scannedBarcode:m,showAddProductForm:C,productFound:b,isLoadingProduct:R,quaggaContainerRef:S,startCamera:V,stopCamera:$,showCameraPermissionPrompt:re,setShowCameraPrompt:d,handleProductAdded:de,handleCancelAddProduct:p,resetScannerUi:K}}function Xt({ingredients:s,onIngredientsChange:n,onAnalysisRequest:r,onAddProductFormChange:a}){const[o,u]=t.useState("unknown"),{isScanning:d,showCameraPrompt:v,setShowCameraPrompt:c,cameraError:g,barcodeError:l,barcodeDebug:f,scannedBarcode:h,showAddProductForm:m,productFound:y,isLoadingProduct:C,quaggaContainerRef:j,startCamera:b,stopCamera:w,handleProductAdded:R,handleCancelAddProduct:F,resetScannerUi:S}=Vt({onIngredientsFound:n,onAnalyzeText:r,onPermissionChange:u});t.useEffect(()=>{a(m)},[a,m]),t.useEffect(()=>()=>{S(),a(!1)},[a,S]);const A=t.useMemo(()=>typeof navigator<"u"&&!!navigator.mediaDevices,[]);return e.jsxs("div",{className:"space-y-4",children:[e.jsx(Gt,{showAddProductForm:m,scannedBarcode:h,onProductAdded:R,onCancelAddProduct:F,barcodeError:l,barcodeDebug:f,cameraError:g,cameraPermission:o,onRequestCameraPermission:()=>c(!0),isScanning:d,isLoadingProduct:C,onStartCamera:b,onStopCamera:w,productFound:y,quaggaContainerRef:j,canUseCamera:A,ingredients:s,onIngredientsChange:n,activeTab:"barcode"}),e.jsx(ft,{open:v,onOpenChange:c,children:e.jsxs(gt,{className:"sm:max-w-md",children:[e.jsxs(vt,{children:[e.jsxs(jt,{className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-5 w-5"}),"Camera Access Required"]}),e.jsx(yt,{asChild:!0,children:e.jsxs("div",{className:"space-y-3 text-left",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(qe,{className:"h-4 w-4 mt-0.5 text-blue-500 flex-shrink-0"}),e.jsx("span",{children:"This app needs access to your camera to scan product barcodes."})]}),e.jsxs("div",{className:"bg-muted p-3 rounded-lg text-sm",children:[e.jsx("div",{className:"font-medium mb-2",children:"What will happen next:"}),e.jsxs("ol",{className:"list-decimal list-inside space-y-1",children:[e.jsx("li",{children:"Your browser will ask for camera permission"}),e.jsx("li",{children:'Click "Allow" to enable the camera'}),e.jsx("li",{children:"Point your camera at a product barcode"}),e.jsx("li",{children:'Tap "Scan Barcode" to read the code'})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Your privacy is protected - camera feed stays on your device."})]})})]}),e.jsxs(bt,{className:"flex gap-2 sm:justify-between",children:[e.jsx(P,{variant:"outline",onClick:()=>c(!1),children:"Cancel"}),e.jsx(P,{onClick:()=>{c(!1),b()},children:"Enable Camera"})]})]})})]})}export{Xt as BarcodeScannerSection};
